QEMU = @QEMU@ -machine accel=kvm -cpu host
CROSSDIR = @CROSSDIR@
JOBS = $(shell nproc)
ARCH_OPT = @ARCH_OPT@

default:
	make PATH=$(PATH):$(CROSSDIR) ARCH_OPT="$(ARCH_OPT)" -C hermit
	make PATH=$(PATH):$(CROSSDIR) ARCH_OPT="$(ARCH_OPT)" -C hermit/tools proxy

travis:
	make PATH=$(PATH):$(CROSSDIR) ARCH_OPT="$(ARCH_OPT)" -C hermit
	make PATH=$(PATH):$(CROSSDIR) ARCH_OPT="$(ARCH_OPT)" -C hermit/tools proxy

all: default

test:
	. ./test.sh

qemu:
	$(QEMU) -smp 10 -m 8G -numa node,nodeid=0,cpus=0-4 -numa node,nodeid=1,cpus=5-9 \
		-kernel config/bzImage \
		-append "root=/dev/ram0 rootfstype=ramfs init=init console=ttyS0" \
		-net nic,model=rtl8139 -net user -net dump \
		-nographic -monitor telnet:127.0.0.1:1235,server,nowait \
		-fsdev local,security_model=none,id=fsdev0,path=$(shell realpath hermit) \
		-device virtio-9p-pci,id=fs0,fsdev=fsdev0,mount_tag=hermit \
		-s
clean:
	make -C hermit clean

veryclean:
	make -C hermit veryclean

.PHONY: default all clean veryclean test
